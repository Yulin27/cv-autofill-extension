<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CV Parsing Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    .config-section {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .input-group label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    .input-group input, .input-group select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #059669;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .status.loading {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .output {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      max-height: 500px;
      overflow-y: auto;
    }
    .output pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .cv-display {
      background: white;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .cv-section {
      margin-bottom: 20px;
    }
    .cv-section h3 {
      margin: 0 0 10px 0;
      color: #10b981;
      font-size: 16px;
      border-bottom: 2px solid #10b981;
      padding-bottom: 5px;
    }
    .cv-item {
      margin-bottom: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 4px;
    }
    .cv-item strong {
      color: #333;
    }
    .cv-item p {
      margin: 5px 0;
      color: #666;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CV Parsing Test - Full Workflow</h1>
    <p class="subtitle">Test complete PDF extraction → LLM parsing → Structured data</p>

    <!-- Configuration -->
    <div class="test-section">
      <h2>Configuration</h2>
      <div class="config-section">
        <div class="input-group">
          <label>API Provider</label>
          <select id="apiProvider">
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
          </select>
        </div>
        <div class="input-group">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="Enter your API key">
        </div>
        <div class="input-group">
          <label>PDF File</label>
          <input type="file" id="pdfFile" accept=".pdf">
        </div>
      </div>
    </div>

    <!-- Full Test -->
    <div class="test-section">
      <h2>Full CV Parsing Test</h2>
      <div style="display: flex; gap: 10px;">
        <button id="parseBtn">Parse CV</button>
        <button id="testFileBtn" class="secondary">Use Test File (Yulin-SHI-CV.pdf)</button>
      </div>
      <div id="parseStatus"></div>

      <div class="two-column" id="resultsSection" style="display: none; margin-top: 20px;">
        <div>
          <h3 style="margin-top: 0;">Raw Extracted Text</h3>
          <div id="extractedText" class="output"></div>
        </div>
        <div>
          <h3 style="margin-top: 0;">Structured CV Data</h3>
          <div id="structuredData" class="cv-display"></div>
        </div>
      </div>

      <div id="jsonOutput" class="output" style="display: none; margin-top: 20px;">
        <h3 style="margin-top: 0;">JSON Output</h3>
        <pre id="jsonContent"></pre>
      </div>
    </div>
  </div>

  <script type="module">
    import { extractTextFromPDF } from '../utils/pdf-parser.js';
    import { LLMClient } from '../core/llm-client.js';
    import { CVParser } from '../core/cv-parser.js';

    let extractedText = '';
    let parsedCV = null;

    // Use test file button
    document.getElementById('testFileBtn').addEventListener('click', async () => {
      try {
        const response = await fetch('../test/test_data/Yulin-SHI-CV.pdf');
        const blob = await response.blob();
        const file = new File([blob], 'Yulin-SHI-CV.pdf', { type: 'application/pdf' });

        // Create a FileList-like object
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('pdfFile').files = dataTransfer.files;

        document.getElementById('parseStatus').innerHTML =
          '<div class="status success">Test file loaded! Click "Parse CV" to proceed.</div>';
      } catch (error) {
        document.getElementById('parseStatus').innerHTML =
          `<div class="status error">Error loading test file: ${error.message}</div>`;
      }
    });

    // Parse CV button
    document.getElementById('parseBtn').addEventListener('click', async () => {
      const apiProvider = document.getElementById('apiProvider').value;
      const apiKey = document.getElementById('apiKey').value;
      const pdfFile = document.getElementById('pdfFile').files[0];
      const statusDiv = document.getElementById('parseStatus');
      const resultsSection = document.getElementById('resultsSection');
      const jsonOutput = document.getElementById('jsonOutput');

      // Validation
      if (!apiKey) {
        statusDiv.innerHTML = '<div class="status error">Please enter your API key</div>';
        return;
      }

      if (!pdfFile) {
        statusDiv.innerHTML = '<div class="status error">Please select a PDF file</div>';
        return;
      }

      // Hide previous results
      resultsSection.style.display = 'none';
      jsonOutput.style.display = 'none';

      try {
        // Step 1: Extract text from PDF
        statusDiv.innerHTML = '<div class="status loading">Step 1/3: Extracting text from PDF...</div>';
        const arrayBuffer = await pdfFile.arrayBuffer();
        extractedText = await extractTextFromPDF(arrayBuffer);

        if (!extractedText || extractedText.length < 50) {
          throw new Error('Extracted text is too short or empty');
        }

        console.log(`Extracted ${extractedText.length} characters`);

        // Step 2: Initialize LLM Client
        statusDiv.innerHTML = '<div class="status loading">Step 2/3: Connecting to LLM API...</div>';
        const llmClient = new LLMClient(apiKey, apiProvider);

        // Test connection
        const isValid = await llmClient.testConnection();
        if (!isValid) {
          throw new Error('API key validation failed');
        }

        // Step 3: Parse CV with LLM
        statusDiv.innerHTML = '<div class="status loading">Step 3/3: Parsing CV with AI (this may take 10-30 seconds)...</div>';
        const cvParser = new CVParser(llmClient);
        parsedCV = await cvParser.parse(extractedText);

        // Display results
        statusDiv.innerHTML = '<div class="status success">CV parsed successfully!</div>';
        displayResults(extractedText, parsedCV);

      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
        console.error('Parsing error:', error);
      }
    });

    function displayResults(text, cvData) {
      const resultsSection = document.getElementById('resultsSection');
      const extractedTextDiv = document.getElementById('extractedText');
      const structuredDataDiv = document.getElementById('structuredData');
      const jsonOutput = document.getElementById('jsonOutput');
      const jsonContent = document.getElementById('jsonContent');

      // Show results section
      resultsSection.style.display = 'grid';
      jsonOutput.style.display = 'block';

      // Display extracted text (first 2000 chars)
      const truncatedText = text.length > 2000 ? text.substring(0, 2000) + '\n\n... (truncated)' : text;
      extractedTextDiv.innerHTML = `<pre>${truncatedText}</pre>`;

      // Display structured CV data
      structuredDataDiv.innerHTML = formatCVData(cvData);

      // Display JSON
      jsonContent.textContent = JSON.stringify(cvData, null, 2);
    }

    function formatCVData(cv) {
      let html = '';

      // Personal Info
      if (cv.personalInfo) {
        html += '<div class="cv-section">';
        html += '<h3>Personal Information</h3>';
        html += '<div class="cv-item">';
        html += `<p><strong>Name:</strong> ${cv.personalInfo.fullName || 'N/A'}</p>`;
        html += `<p><strong>Email:</strong> ${cv.personalInfo.email || 'N/A'}</p>`;
        html += `<p><strong>Phone:</strong> ${cv.personalInfo.phone || 'N/A'}</p>`;
        html += `<p><strong>Location:</strong> ${cv.personalInfo.location || 'N/A'}</p>`;
        if (cv.personalInfo.linkedin) html += `<p><strong>LinkedIn:</strong> ${cv.personalInfo.linkedin}</p>`;
        if (cv.personalInfo.website) html += `<p><strong>Website:</strong> ${cv.personalInfo.website}</p>`;
        html += '</div>';
        html += '</div>';
      }

      // Summary
      if (cv.summary) {
        html += '<div class="cv-section">';
        html += '<h3>Summary</h3>';
        html += `<div class="cv-item"><p>${cv.summary}</p></div>`;
        html += '</div>';
      }

      // Work Experience
      if (cv.workExperience && cv.workExperience.length > 0) {
        html += '<div class="cv-section">';
        html += '<h3>Work Experience</h3>';
        cv.workExperience.forEach(job => {
          html += '<div class="cv-item">';
          html += `<p><strong>${job.position}</strong> at ${job.company}</p>`;
          html += `<p>${job.startDate} - ${job.endDate}</p>`;
          if (job.description) html += `<p>${job.description}</p>`;
          if (job.achievements && job.achievements.length > 0) {
            html += '<ul>';
            job.achievements.forEach(ach => html += `<li>${ach}</li>`);
            html += '</ul>';
          }
          html += '</div>';
        });
        html += '</div>';
      }

      // Education
      if (cv.education && cv.education.length > 0) {
        html += '<div class="cv-section">';
        html += '<h3>Education</h3>';
        cv.education.forEach(edu => {
          html += '<div class="cv-item">';
          html += `<p><strong>${edu.degree}</strong> in ${edu.field || 'N/A'}</p>`;
          html += `<p>${edu.institution} - ${edu.graduationDate}</p>`;
          html += '</div>';
        });
        html += '</div>';
      }

      // Skills
      if (cv.skills) {
        html += '<div class="cv-section">';
        html += '<h3>Skills</h3>';
        html += '<div class="cv-item">';
        if (cv.skills.technical && cv.skills.technical.length > 0) {
          html += `<p><strong>Technical:</strong> ${cv.skills.technical.join(', ')}</p>`;
        }
        if (cv.skills.languages && cv.skills.languages.length > 0) {
          html += `<p><strong>Languages:</strong> ${cv.skills.languages.join(', ')}</p>`;
        }
        if (cv.skills.soft && cv.skills.soft.length > 0) {
          html += `<p><strong>Soft Skills:</strong> ${cv.skills.soft.join(', ')}</p>`;
        }
        html += '</div>';
        html += '</div>';
      }

      // Certifications
      if (cv.certifications && cv.certifications.length > 0) {
        html += '<div class="cv-section">';
        html += '<h3>Certifications</h3>';
        cv.certifications.forEach(cert => {
          html += `<div class="cv-item"><p>${cert}</p></div>`;
        });
        html += '</div>';
      }

      return html;
    }
  </script>
</body>
</html>
